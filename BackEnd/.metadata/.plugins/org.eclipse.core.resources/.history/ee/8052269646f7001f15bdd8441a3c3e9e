package com.portfolio.service;

import com.portfolio.exception.ResourceNotFoundException;
import com.portfolio.repository.UserDetailsRepository;
import com.portfolio.vo.UserDetails;
import com.portfolio.vo.UserInstance;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.List;

@Service
public class UserDetailsServiceImpl implements UserDetailsService {
	
    private static final Logger logger = LoggerFactory.getLogger(UserDetailsServiceImpl.class);

    @Autowired
    private UserDetailsRepository userDetailsRepository;

    @Autowired
    private GoogleDriveService googleDriveService;

    @Override
    public List<UserDetails> getAllUserDetails() {
        return userDetailsRepository.findByIsActive('Y');
    }

    @PostMapping("/createUser")
    public ResponseEntity<Void> createUser(@RequestParam("user") String userJson, @RequestParam("resumeFilePath") String resumeFilePath) {
        try {
            // Convert the user JSON to UserDetails object
            ObjectMapper objectMapper = new ObjectMapper();
            UserDetails user = objectMapper.readValue(userJson, UserDetails.class);

            // Call the service to create the user and store the local file path
            userService.createUser(user, resumeFilePath);

            // Return HTTP 201 Created response
            return ResponseEntity.status(201).build();
        } catch (Exception e) {
            return ResponseEntity.status(400).build(); // Return HTTP 400 Bad Request
        }
    }
    @Override
    public UserDetails getUserById(Integer userId) {
        return userDetailsRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException("User not found"));
    }

    @Override
    public UserDetails updateUser(UserDetails user, MultipartFile resumeFile) {
        if (resumeFile != null && !resumeFile.isEmpty()) {
            try {
                String fileId = googleDriveService.uploadFile(resumeFile);
                user.setResumePath(fileId);
            } catch (Exception e) {
                throw new RuntimeException("Failed to upload resume", e);
            }
        }
        return userDetailsRepository.save(user);
    }

    @Override
    public void deleteUser(Integer userId) {
        userDetailsRepository.findById(userId).ifPresent(existingUser -> {
            existingUser.setIsActive('N');
            userDetailsRepository.save(existingUser);
        });
    }
}